#!/bin/bash
set -e

# copilot-container - Run GitHub Copilot CLI in a sandboxed container
# 
# Usage:
#   copilot-container --mount /path/to/project [--yolo]
#   copilot-container --clone owner/repo [--yolo]

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
IMAGE_NAME="copilot-cli-container"
CONTAINER_NAME="copilot-cli-$$"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Detect container runtime
detect_runtime() {
    if command -v docker &> /dev/null; then
        echo "docker"
    elif command -v podman &> /dev/null; then
        echo "podman"
    else
        log_error "Neither docker nor podman found. Please install one."
        exit 1
    fi
}

# Auto-detect GitHub token
detect_gh_token() {
    # Priority: explicit env var > gh CLI
    if [ -n "$GH_TOKEN" ]; then
        echo "$GH_TOKEN"
    elif [ -n "$GITHUB_TOKEN" ]; then
        echo "$GITHUB_TOKEN"
    elif command -v gh &> /dev/null && gh auth status &>/dev/null; then
        gh auth token 2>/dev/null
    fi
}

show_help() {
    cat << 'EOF'
copilot-container - Run GitHub Copilot CLI in a sandboxed container

USAGE:
    copilot-container [OPTIONS]

OPTIONS:
    --mount <path>          Mount local directory (changes apply directly)
    --clone <owner/repo>    Clone fresh from GitHub
    --yolo                  Enable auto-accept mode in Copilot CLI
    --build                 Build/rebuild the container image
    --shell                 Start a shell instead of Copilot CLI
    -h, --help              Show this help message

EXAMPLES:
    # Work on a local project
    copilot-container --mount ~/my-project

    # Work with auto-accept mode (use git for recovery)
    copilot-container --mount ~/my-project --yolo

    # Clone and work on a fresh repo
    copilot-container --clone facebook/react

ENVIRONMENT:
    GH_TOKEN or GITHUB_TOKEN - GitHub token for Copilot authentication
    (Auto-detected from `gh auth token` if available)

SECURITY:
    - Container can ONLY access the mounted project directory
    - No access to your home directory, system files, or other projects
    - Use git for recovery: `git checkout .` or `git stash`

EOF
}

build_image() {
    local runtime=$(detect_runtime)
    log_info "Building container image with $runtime..."
    cd "$SCRIPT_DIR"
    $runtime build -t "$IMAGE_NAME" .
    log_info "Image built successfully: $IMAGE_NAME"
}

run_container() {
    local runtime=$(detect_runtime)
    local mode="$1"
    local path="$2"
    local extra_args=("${@:3}")
    
    # Base docker/podman run arguments
    local run_args=(
        --rm
        -it
        --name "$CONTAINER_NAME"
        --hostname copilot-container
    )
    
    # Pass GitHub token (auto-detect from gh CLI if not set)
    local token=$(detect_gh_token)
    if [ -n "$token" ]; then
        run_args+=(-e "GH_TOKEN=$token")
        log_info "Using GitHub token from $([ -n "$GH_TOKEN" ] && echo 'GH_TOKEN' || ([ -n "$GITHUB_TOKEN" ] && echo 'GITHUB_TOKEN' || echo 'gh CLI'))"
    fi
    
    # Handle different modes
    case "$mode" in
        mount)
            local abs_path=$(cd "$path" && pwd)
            run_args+=(-v "$abs_path:/workspace")
            ;;
        clone)
            run_args+=(-e "COPILOT_CLONE_REPO=$path")
            ;;
    esac
    
    # Add security restrictions
    run_args+=(
        --security-opt no-new-privileges
        --read-only
        --tmpfs /tmp
        --tmpfs /home/copilot:exec,mode=1777
    )
    
    # Run the container
    log_info "Starting Copilot CLI container ($mode mode)..."
    $runtime run "${run_args[@]}" "$IMAGE_NAME" "${extra_args[@]}"
}

# Parse arguments
MODE=""
PATH_ARG=""
COPILOT_ARGS=()
SHELL_MODE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --mount)
            MODE="mount"
            PATH_ARG="$2"
            shift 2
            ;;
        --clone)
            MODE="clone"
            PATH_ARG="$2"
            shift 2
            ;;
        --yolo)
            COPILOT_ARGS+=("--yolo")
            shift
            ;;
        --build)
            build_image
            exit 0
            ;;
        --shell)
            SHELL_MODE=true
            shift
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            log_error "Unknown option: $1"
            show_help
            exit 1
            ;;
    esac
done

# Validate arguments
if [ -z "$MODE" ]; then
    log_error "No mode specified. Use --mount or --clone."
    echo ""
    show_help
    exit 1
fi

# Validate path exists for mount mode
if [ "$MODE" == "mount" ]; then
    if [ ! -d "$PATH_ARG" ]; then
        log_error "Directory does not exist: $PATH_ARG"
        exit 1
    fi
fi

# Check if image exists, build if not
runtime=$(detect_runtime)
if ! $runtime image inspect "$IMAGE_NAME" &> /dev/null; then
    log_warn "Image not found. Building..."
    build_image
fi

# Determine what to run
if [ "$SHELL_MODE" = true ]; then
    run_container "$MODE" "$PATH_ARG" /bin/bash
else
    run_container "$MODE" "$PATH_ARG" copilot "${COPILOT_ARGS[@]}"
fi
